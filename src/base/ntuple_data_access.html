

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NTuple Data Access &mdash; DTPatternRecognition 3.0.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=9edc463e" />
      <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
      <link rel="stylesheet" type="text/css" href="../../_static/sphinx-design.min.css?v=95c83b7e" />

  
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=acc74ff5"></script>
      <script src="../../_static/doctools.js?v=fd6eb6e6"></script>
      <script src="../../_static/sphinx_highlight.js?v=6ffebe34"></script>
      <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
      <script src="../../_static/copybutton.js?v=f281be69"></script>
      <script src="../../_static/design-tabs.js?v=f930bc37"></script>
      <script src="https://cdn.jsdelivr.net/npm/d3@7.9.0/dist/d3.min.js"></script>
      <script type="module">import mermaid from "https://cdn.jsdelivr.net/npm/mermaid@11.12.1/dist/mermaid.esm.min.mjs";





const initStyles = () => {
    const defaultStyle = document.createElement('style');
    defaultStyle.textContent = `pre.mermaid {
    /* Same as .mermaid-container > pre */
    display: block;
    width: 100%;
}

pre.mermaid > svg {
    /* Same as .mermaid-container > pre > svg */
    height: 500px;
    width: 100%;
    max-width: 100% !important;
}`;
    document.head.appendChild(defaultStyle);

    const fullscreenStyle = document.createElement('style');
    fullscreenStyle.textContent = `.mermaid-container {
    display: flex;
    flex-direction: row;
    width: 100%;
}

.mermaid-container > pre {
    display: block;
    width: 100%;
}

.mermaid-container > pre > svg {
    height: 500px;
    width: 100%;
    max-width: 100% !important;
}

.mermaid-fullscreen-btn {
    width: 28px;
    height: 28px;
    background: rgba(255, 255, 255, 0.95);
    border: 1px solid rgba(0, 0, 0, 0.3);
    border-radius: 4px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
    font-size: 14px;
    line-height: 1;
    padding: 0;
    color: #333;
}

.mermaid-fullscreen-btn:hover {
    opacity: 100% !important;
    background: rgba(255, 255, 255, 1);
    box-shadow: 0 3px 10px rgba(0, 0, 0, 0.3);
    transform: scale(1.1);
}

.mermaid-fullscreen-btn.dark-theme {
    background: rgba(50, 50, 50, 0.95);
    border: 1px solid rgba(255, 255, 255, 0.3);
    color: #e0e0e0;
}

.mermaid-fullscreen-btn.dark-theme:hover {
    background: rgba(60, 60, 60, 1);
    box-shadow: 0 3px 10px rgba(255, 255, 255, 0.2);
}

.mermaid-fullscreen-modal {
    display: none;
    position: fixed !important;
    top: 0 !important;
    left: 0 !important;
    width: 95vw;
    height: 100vh;
    background: rgba(255, 255, 255, 0.98);
    z-index: 9999;
    padding: 20px;
    overflow: auto;
}

.mermaid-fullscreen-modal.dark-theme {
    background: rgba(0, 0, 0, 0.98);
}

.mermaid-fullscreen-modal.active {
    display: flex;
    align-items: center;
    justify-content: center;
}

.mermaid-container-fullscreen {
    position: relative;
    width: 95vw;
    height: 90vh;
    max-width: 95vw;
    max-height: 90vh;
    background: white;
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
    overflow: auto;
    display: flex;
    align-items: center;
    justify-content: center;
}

.mermaid-container-fullscreen.dark-theme {
    background: #1a1a1a;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.8);
}

.mermaid-container-fullscreen pre.mermaid {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
}

.mermaid-container-fullscreen .mermaid svg {
    height: 100% !important;
    width: 100% !important;
    cursor: grab;
}

.mermaid-fullscreen-close {
    position: fixed !important;
    top: 20px !important;
    right: 20px !important;
    width: 40px;
    height: 40px;
    background: rgba(255, 255, 255, 0.95);
    border: 1px solid rgba(0, 0, 0, 0.2);
    border-radius: 50%;
    cursor: pointer;
    z-index: 10000;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    transition: all 0.2s;
    font-size: 24px;
    line-height: 1;
    color: #333;
}

.mermaid-fullscreen-close:hover {
    background: white;
    box-shadow: 0 6px 16px rgba(0, 0, 0, 0.4);
    transform: scale(1.1);
}

.mermaid-fullscreen-close.dark-theme {
    background: rgba(50, 50, 50, 0.95);
    border: 1px solid rgba(255, 255, 255, 0.2);
    color: #e0e0e0;
}

.mermaid-fullscreen-close.dark-theme:hover {
    background: rgba(60, 60, 60, 1);
    box-shadow: 0 6px 16px rgba(255, 255, 255, 0.2);
}

.mermaid-fullscreen-modal .mermaid-fullscreen-btn {
    display: none !important;
}`;
    document.head.appendChild(fullscreenStyle);
}

// Detect if page has dark background
const isDarkTheme = () => {
    // We use a set of heuristics:
    // 1. Check for common dark mode classes or attributes
    // 2. Check computed background color brightness
    if (document.documentElement.classList.contains('dark') ||
        document.documentElement.getAttribute('data-theme') === 'dark' ||
        document.body.classList.contains('dark') ||
        document.body.getAttribute('data-theme') === 'dark') {
        // console.log("Dark theme detected via class/attribute");
        return true;
    }
    if (document.documentElement.classList.contains('light') ||
        document.documentElement.getAttribute('data-theme') === 'light' ||
        document.body.classList.contains('light') ||
        document.body.getAttribute('data-theme') === 'light') {
        // console.log("Light theme detected via class/attribute");
        return false;
    }
    if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
        // console.log("Dark theme detected via prefers-color-scheme");
        return true;
    }
    const bgColor = window.getComputedStyle(document.body).backgroundColor;
    const match = bgColor.match(/rgb\((\d+),\s*(\d+),\s*(\d+)/);
    if (match) {
        const r = parseInt(match[1]);
        const g = parseInt(match[2]);
        const b = parseInt(match[3]);
        const brightness = (r * 299 + g * 587 + b * 114) / 1000;
        // console.log("Background color brightness:", brightness);
        return brightness < 128;
    }
    // console.log("No dark or light theme detected, defaulting to light theme");
    return false;
};

let darkTheme = isDarkTheme();
let modal = null;
let modalContent = null;
let previousScrollOffset = [window.scrollX, window.scrollY];

const runMermaid = async (rerun) => {
    console.log("Running mermaid diagrams, rerun =", rerun);
    // clear all existing mermaid charts
    let all_mermaids = document.querySelectorAll(".mermaid");

    if (rerun) {
        all_mermaids.forEach((el) => {
            if(!el.hasAttribute("data-original-code")) {
                // store original code
                // console.log(`Storing original code for first run: `, el.innerHTML);
                el.setAttribute('data-original-code', el.innerHTML);
            }
            if(el.getAttribute("data-processed") === "true") {
                // remove and restore original
                el.removeAttribute("data-processed");
                // console.log(`Restoring original code for re-run: `, el.getAttribute('data-original-code'));
                el.innerHTML = el.getAttribute('data-original-code');
            } else {
                // store original code
                // console.log(`Storing original code for re-run: `, el.innerHTML);
                el.setAttribute('data-original-code', el.innerHTML);
            }
        });
        await mermaid.run();
    }

    all_mermaids = document.querySelectorAll(".mermaid");
    const mermaids_processed = document.querySelectorAll(".mermaid[data-processed='true']");

    if ("False" === "True") {
        const mermaids_to_add_zoom = -1 === -1 ? all_mermaids.length : -1;
        if(mermaids_to_add_zoom > 0) {
            var svgs = d3.selectAll("");
            if(all_mermaids.length !== mermaids_processed.length) {
                setTimeout(() => runMermaid(false), 200);
                return;
            } else if(svgs.size() !== mermaids_to_add_zoom) {
                setTimeout(() => runMermaid(false), 200);
                return;
            } else {
                svgs.each(function() {
                    var svg = d3.select(this);
                    svg.html("<g class='wrapper'>" + svg.html() + "</g>");
                    var inner = svg.select("g");
                    var zoom = d3.zoom().on("zoom", function(event) {
                        inner.attr("transform", event.transform);
                    });
                    svg.call(zoom);
                });
            }
        }
    } else if(all_mermaids.length !== mermaids_processed.length) {
        // Wait for mermaid to process all diagrams
        setTimeout(() => runMermaid(false), 200);
        return;
    }

    // Stop here if not adding fullscreen capability
    if ("True" !== "True") return;

    if (modal !== null ) {
        // Destroy existing modal
        modal.remove();
        modal = null;
        modalContent = null;
    }

    modal = document.createElement('div');
    modal.className = 'mermaid-fullscreen-modal' + (darkTheme ? ' dark-theme' : '');
    modal.setAttribute('role', 'dialog');
    modal.setAttribute('aria-modal', 'true');
    modal.setAttribute('aria-label', 'Fullscreen diagram viewer');
    modal.innerHTML = `
        <button class="mermaid-fullscreen-close${darkTheme ? ' dark-theme' : ''}" aria-label="Close fullscreen">✕</button>
        <div class="mermaid-container-fullscreen${darkTheme ? ' dark-theme' : ''}"></div>
    `;
    document.body.appendChild(modal);

    modalContent = modal.querySelector('.mermaid-container-fullscreen');
    const closeBtn = modal.querySelector('.mermaid-fullscreen-close');

    const closeModal = () => {
        modal.classList.remove('active');
        modalContent.innerHTML = '';
        document.body.style.overflow = ''
        window.scrollTo({left: previousScrollOffset[0], top: previousScrollOffset[1], behavior: 'instant'});
    };

    closeBtn.addEventListener('click', closeModal);
    modal.addEventListener('click', (e) => {
        if (e.target === modal) closeModal();
    });
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && modal.classList.contains('active')) {
            closeModal();
        }
    });

    document.querySelectorAll('.mermaid').forEach((mermaidDiv) => {
        if (mermaidDiv.parentNode.classList.contains('mermaid-container') ||
            mermaidDiv.closest('.mermaid-fullscreen-modal')) {
            // Already processed, adjust button class if needed
            const existingBtn = mermaidDiv.parentNode.querySelector('.mermaid-fullscreen-btn');
            if (existingBtn) {
                existingBtn.className = 'mermaid-fullscreen-btn' + (darkTheme ? ' dark-theme' : '');
            }
            return;
        }

        const container = document.createElement('div');
        container.className = 'mermaid-container';
        mermaidDiv.parentNode.insertBefore(container, mermaidDiv);
        container.appendChild(mermaidDiv);

        const fullscreenBtn = document.createElement('button');
        fullscreenBtn.className = 'mermaid-fullscreen-btn' + (darkTheme ? ' dark-theme' : '');
        fullscreenBtn.setAttribute('aria-label', 'View diagram in fullscreen');
        fullscreenBtn.textContent = '⛶';
        fullscreenBtn.style.opacity = '50%';

        // Calculate dynamic position based on diagram's margin and padding
        const diagramStyle = window.getComputedStyle(mermaidDiv);
        const marginTop = parseFloat(diagramStyle.marginTop) || 0;
        const marginRight = parseFloat(diagramStyle.marginRight) || 0;
        const paddingTop = parseFloat(diagramStyle.paddingTop) || 0;
        const paddingRight = parseFloat(diagramStyle.paddingRight) || 0;
        fullscreenBtn.style.top = `${marginTop + paddingTop + 4}px`;
        fullscreenBtn.style.right = `${marginRight + paddingRight + 4}px`;

        fullscreenBtn.addEventListener('click', () => {
            previousScrollOffset = [window.scroll, window.scrollY];
            const clone = mermaidDiv.cloneNode(true);
            modalContent.innerHTML = '';
            modalContent.appendChild(clone);

            const svg = clone.querySelector('svg');
            if (svg) {
                svg.removeAttribute('width');
                svg.removeAttribute('height');
                svg.style.width = '100%';
                svg.style.height = 'auto';
                svg.style.maxWidth = '100%';
                svg.style.sdisplay = 'block';

                if ("False" === "True") {
                    setTimeout(() => {
                        const g = svg.querySelector('g');
                        if (g) {
                            var svgD3 = d3.select(svg);
                            svgD3.html("<g class='wrapper'>" + svgD3.html() + "</g>");
                            var inner = svgD3.select("g");
                            var zoom = d3.zoom().on("zoom", function(event) {
                                inner.attr("transform", event.transform);
                            });
                            svgD3.call(zoom);
                        }
                    }, 100);
                }
            }

            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
        });
        container.appendChild(fullscreenBtn);
    });
};

const load = async () => {
    initStyles();

    await runMermaid(true);

    const reRunIfThemeChanges = async () => {
        const newDarkTheme = isDarkTheme();
        if (newDarkTheme !== darkTheme) {
            darkTheme = newDarkTheme;
            console.log("Theme change detected, re-running mermaid with", darkTheme ? "dark" : "default", "theme");
            await mermaid.initialize(
                {...JSON.parse(
                    `{"startOnLoad": false}`
                ),
                ...{ darkMode: darkTheme, theme: darkTheme ? 'dark' : 'default' },
                }
            );
            await runMermaid(true);
        }
    };

    // Update theme classes when theme changes
    const themeObserver = new MutationObserver(reRunIfThemeChanges);
    themeObserver.observe(document.documentElement, {
        attributes: true,
        attributeFilter: ['class', 'style', 'data-theme']
    });
    themeObserver.observe(document.body, {
        attributes: true,
        attributeFilter: ['class', 'style', 'data-theme']
    });
};





console.log("Initializing mermaid with", darkTheme ? "dark" : "default", "theme");
mermaid.initialize(
    {...JSON.parse(
        `{"startOnLoad": false}`
    ),
    ...{ darkMode: darkTheme, theme: darkTheme ? 'dark' : 'default' },
    }
);

window.addEventListener("load", load);</script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Configuration Management" href="configuration_management.html" />
    <link rel="prev" title="Event Abstraction" href="event_abstraction.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            DTPatternRecognition
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Installation</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="main.html">Base</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="particle_abstraction.html">Particle Abstraction</a></li>
<li class="toctree-l2"><a class="reference internal" href="event_abstraction.html">Event Abstraction</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">NTuple Data Access</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#example-preprocessor-and-selector-functions">Example: Preprocessor and Selector Functions</a></li>
<li class="toctree-l3"><a class="reference internal" href="#how-data-is-accessed">How Data is Accessed</a></li>
<li class="toctree-l3"><a class="reference internal" href="#eventlist">EventList</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="configuration_management.html">Configuration Management</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../command_line_interface.html">Command Line Interface (CLI)</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">DTPatternRecognition</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="main.html">Base</a></li>
      <li class="breadcrumb-item active">NTuple Data Access</li>
      <li class="wy-breadcrumbs-aside">
              <!-- User defined GitHub URL -->
              <a href="https://github.com/INTREPID-hep/DTPatternRecognition" class="fa fa-github"> Edit on GitHub</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="ntuple-data-access">
<h1>NTuple Data Access<a class="headerlink" href="#ntuple-data-access" title="Link to this heading"></a></h1>
<p>The <code class="docutils literal notranslate"><span class="pre">NTuple</span></code> class serves as a gateway for accessing information from one or more <code class="docutils literal notranslate"><span class="pre">.root</span></code> NTuples located in a specified input path. It provides an interface to build <code class="docutils literal notranslate"><span class="pre">Event</span></code> instances directly from TTree event entries, supporting preprocessing, filtering, and dynamic event construction according to the <strong>preprocessors</strong> and <strong>selectors</strong> specified in the configuration.</p>
<p>A <strong>preprocessor</strong> is a function that takes an <code class="docutils literal notranslate"><span class="pre">Event</span></code> instance as input and applies any necessary modifications or additions. A <strong>selector</strong> is a function that returns a boolean based on the information of an <code class="docutils literal notranslate"><span class="pre">Event</span></code>, allowing for event filtering.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">NTuple</span></code> class is designed to be generic and handle many types of NTuple formats, since <code class="docutils literal notranslate"><span class="pre">Event</span></code> creation is controlled through a <code class="docutils literal notranslate"><span class="pre">YAML</span></code> <strong>configuration file</strong>. Internally, the <code class="docutils literal notranslate"><span class="pre">NTuple</span></code> class loads the ROOT TTree via a TChain (accessible via the <code class="docutils literal notranslate"><span class="pre">tree</span></code> attribute), and generates <code class="docutils literal notranslate"><span class="pre">Event</span></code> instances on demand (via the <code class="docutils literal notranslate"><span class="pre">events</span></code> attribute), applying preprocessors and selectors before returning each event.</p>
<p>The preprocessing feature allows selectors to be based on properties not present in the input NTuples, but computed via extra preprocessing steps.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">NTuple</span></code> class supports the following configuration keys:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">ntuple_tree_name</span></code>: The name of the TTree to use (should be the same for all files in the input folder).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ntuple_preprocessors</span></code>:  A map of preprocessors to use in the NTuple.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ntuple_selectors</span></code>: A map of selectors to use in the NTuple.</p></li>
</ul>
<p>Both preprocessors and selectors maps should contain a <code class="docutils literal notranslate"><span class="pre">src</span></code> key specifying the path to the function, and optionally a <code class="docutils literal notranslate"><span class="pre">kwargs</span></code> map for additional parameters.</p>
<p class="rubric">Example configuration</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">ntuple_tree_name</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;/dtNtupleProducer/DTTREE&#39;</span>

<span class="nt">ntuple_preprocessors</span><span class="p">:</span>
<span class="w">  </span><span class="nt">test-preprocessor</span><span class="p">:</span>
<span class="w">    </span><span class="nt">src</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;dtpr.utils.preprocessors.test_preprocessor&#39;</span>
<span class="w">    </span><span class="nt">kwargs</span><span class="p">:</span>
<span class="w">      </span><span class="nt">dummy_val</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">-999</span>

<span class="nt">ntuple_selectors</span><span class="p">:</span>
<span class="w">  </span><span class="nt">test-selector</span><span class="p">:</span>
<span class="w">    </span><span class="nt">src</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;dtpr.utils.selectors.test_selector&#39;</span>
</pre></div>
</div>
<section id="example-preprocessor-and-selector-functions">
<span id="preprocessor-selector-examples"></span><h2>Example: Preprocessor and Selector Functions<a class="headerlink" href="#example-preprocessor-and-selector-functions" title="Link to this heading"></a></h2>
<p>A preprocessor can be used to compute new event-level quantities before selection or analysis. For example, to compute the deltaR between the two generator muons and store it as an attribute in the event:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">..base</span><span class="w"> </span><span class="kn">import</span> <span class="n">Event</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.functions</span><span class="w"> </span><span class="kn">import</span> <span class="n">deltaR</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span>


<span class="k">def</span><span class="w"> </span><span class="nf">test_preprocessor</span><span class="p">(</span><span class="n">event</span><span class="p">:</span> <span class="n">Event</span><span class="p">,</span> <span class="n">dummy_val</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">999</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">p1</span><span class="p">,</span> <span class="n">p2</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">genmuons</span>
        <span class="n">event</span><span class="o">.</span><span class="n">dR</span> <span class="o">=</span> <span class="n">deltaR</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
</pre></div>
</div>
<p>A selector can be used to filter events, for example, to keep only those with at least two generator muons:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">..base</span><span class="w"> </span><span class="kn">import</span> <span class="n">Event</span>


<span class="k">def</span><span class="w"> </span><span class="nf">test_selector</span><span class="p">(</span><span class="n">event</span><span class="p">:</span> <span class="n">Event</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="n">genMuons</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="s2">&quot;genmuons&quot;</span><span class="p">,</span> <span class="p">[])</span>
    <span class="n">AtLeastTwoMuons</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">genMuons</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span>

</pre></div>
</div>
</section>
<section id="how-data-is-accessed">
<h2>How Data is Accessed<a class="headerlink" href="#how-data-is-accessed" title="Link to this heading"></a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">NTuple</span></code> provides efficient, memory-friendly access to event data. The <code class="docutils literal notranslate"><span class="pre">NTuple</span></code> acts as a “Data Hub”
and an auxiliary class, the <code class="docutils literal notranslate"><span class="pre">EventList</span></code> (see below <a class="reference internal" href="#event-list"><span class="std std-ref">EventList</span></a>), as an “Event Factory”, ensuring that
only the requested events are loaded and processed.</p>
<pre  class="mermaid">
        sequenceDiagram
    participant User
    participant NTuple
    participant ROOT_TChain
    participant EventList
    participant Event

    User-&gt;&gt;NTuple: Create NTuple(inputFolder=&quot;path/to/data&quot;)
    NTuple-&gt;&gt;NTuple: Find .root files in inputFolder
    NTuple-&gt;&gt;ROOT_TChain: Create TChain (from ROOT library)
    NTuple-&gt;&gt;ROOT_TChain: Add each .root file to TChain
    NTuple--&gt;&gt;User: NTuple object is ready (contains EventList)

    User-&gt;&gt;EventList: Request an Event (e.g., ntuple.events[5])
    EventList-&gt;&gt;ROOT_TChain: Ask for raw data entry #5
    ROOT_TChain--&gt;&gt;EventList: Provides raw data (ev_entry)
    EventList-&gt;&gt;Event: Create Event(ev_entry, index=5, use_config=True)
    Note over Event: Event dynamically builds Particles based on config
    EventList-&gt;&gt;NTuple: Call NTuple's 'event_processor(Event)'
    Note over NTuple: Applies configured Preprocessors &amp; Selectors
    NTuple--&gt;&gt;EventList: Returns processed Event (or None if filtered)
    EventList--&gt;&gt;User: Return the fully processed Event
    </pre><p><strong>Flow Explanation:</strong></p>
<ol class="arabic simple">
<li><p><strong>NTuple Initialization:</strong>
When an <code class="docutils literal notranslate"><span class="pre">NTuple</span></code> object is created, it scans the input folder for all <code class="docutils literal notranslate"><span class="pre">.root</span></code> files and constructs a ROOT <code class="docutils literal notranslate"><span class="pre">TChain</span></code> to combine them. It then creates an <code class="docutils literal notranslate"><span class="pre">EventList</span></code> instance, passing it the configured <code class="docutils literal notranslate"><span class="pre">TChain</span></code> and its own event processing method.</p></li>
<li><p><strong>Requesting an Event:</strong>
When a specific event is requested (e.g., <code class="docutils literal notranslate"><span class="pre">ntuple.events[5]</span></code>), the <code class="docutils literal notranslate"><span class="pre">EventList</span></code> asks the <code class="docutils literal notranslate"><span class="pre">TChain</span></code> to load only the raw data for that event. It then creates an <code class="docutils literal notranslate"><span class="pre">Event</span></code> object, which dynamically builds its <code class="docutils literal notranslate"><span class="pre">Particle</span></code> collections according to the configuration. Before returning the event, any configured preprocessors and selectors are applied.</p></li>
<li><p><strong>Efficient Access:</strong>
This design ensures that only the requested events are loaded and processed, minimizing memory usage and allowing efficient access to large datasets.</p></li>
</ol>
<p class="rubric">Example usage</p>
<p>The following example shows how to use the <code class="docutils literal notranslate"><span class="pre">NTuple</span></code> class to read DT Ntuples and access events:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">dtpr.base.config</span><span class="w"> </span><span class="kn">import</span> <span class="n">RUN_CONFIG</span>

<span class="c1"># update the configuration file -&gt; if it is not set, it will use the default one &#39;run_config.yaml&#39;</span>
<span class="n">RUN_CONFIG</span><span class="o">.</span><span class="n">change_config_file</span><span class="p">(</span><span class="n">config_path</span><span class="o">=</span><span class="n">cf_path</span><span class="p">)</span>

<span class="c1"># input_file could be the path to the DT Ntuple, or to a folder with several files</span>
<span class="n">ntuple</span> <span class="o">=</span> <span class="n">NTuple</span><span class="p">(</span>
    <span class="n">input_file</span>
<span class="p">)</span>  <span class="c1"># It also admits passing a list of selectors and preprocessors when instantiating</span>

<span class="c1"># you can access events by index or slice such as a list</span>
<span class="nb">print</span><span class="p">(</span><span class="n">ntuple</span><span class="o">.</span><span class="n">events</span><span class="p">[</span><span class="mi">9</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">ntuple</span><span class="o">.</span><span class="n">events</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="mi">5</span><span class="p">])</span>  <span class="c1"># slicing return a generator</span>

<span class="c1"># you can also loop over the events</span>
<span class="k">for</span> <span class="n">iev</span><span class="p">,</span> <span class="n">ev</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ntuple</span><span class="o">.</span><span class="n">events</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">ev</span><span class="p">)</span>
    <span class="k">break</span>

<span class="c1"># or simply, you can still use the TTree (It is a ROOT.TChain)</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ev</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ntuple</span><span class="o">.</span><span class="n">tree</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Event orbit number: </span><span class="si">{</span><span class="n">ev</span><span class="o">.</span><span class="n">event_orbitNumber</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">break</span>
</pre></div>
</div>
<p class="rubric">Output</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>+ Opening input file /root/DTPatternRecognition/test/ntuples/DTDPGNtuple_12_4_2_Phase2Concentrator_thr6_Simulation_99.root
&gt;&gt; ------ Event 39954 info ------
+ Index: 9
+ Digis
    * Number of digis: 167
+ Segments
    * Number of segments: 21
    * AM-Seg matches:
    --&gt; Segment 1 info --&gt;
        - Wh: -2, Sc: 5, St: 1, Phi: 2.2211668491363525, Eta: -0.9381515979766846
    --&gt; Segment 2 info --&gt;
        - Wh: -2, Sc: 5, St: 1, Phi: 2.2211666107177734, Eta: -0.9440188407897949
    --&gt; Segment 8 info --&gt;
        - Wh: -2, Sc: 5, St: 2, Phi: 2.221505880355835, Eta: -0.9430407881736755
    --&gt; Segment 9 info --&gt;
        - Wh: -2, Sc: 5, St: 2, Phi: 2.2215068340301514, Eta: -0.9163724184036255
    --&gt; Segment 10 info --&gt;
        - Wh: -2, Sc: 12, St: 2, Phi: -0.6958962082862854, Eta: -0.8441917300224304
+ Tps
    * Number of tps: 32
+ Genmuons
    * Number of genmuons: 2
    * GenMuon 1 info --&gt;
    --&gt; Pt: 548.1250610351562, Eta: -0.8365859985351562, Phi: -0.6915670037269592, Charge: 1, Matched_segments_stations: [...], Showered: True
    * GenMuon 0 info --&gt;
    --&gt; Pt: 511.7483215332031, Eta: -0.9357022643089294, Phi: 2.2167818546295166, Charge: -1, Matched_segments_stations: [...], Showered: True
+ Emushowers
    * Number of emushowers: 1
+ Simhits
    * Number of simhits: 188
+ Realshowers
    * Number of realshowers: 3
&lt;generator object EventList.__getitem__.&lt;locals&gt;.&lt;genexpr&gt; at 0x...&gt;
&gt;&gt; ------ Event 39956 info ------
+ Index: 0
+ Digis
    * Number of digis: 81
+ Segments
    * Number of segments: 8
    * AM-Seg matches:
    --&gt; Segment 5 info --&gt;
        - Wh: 0, Sc: 8, St: 1, Phi: -2.5716519355773926, Eta: -0.2304154634475708
    --&gt; Segment 7 info --&gt;
        - Wh: -1, Sc: 8, St: 4, Phi: -2.5743513107299805, Eta: -0.36347508430480957
+ Tps
    * Number of tps: 21
+ Genmuons
    * Number of genmuons: 2
    * GenMuon 0 info --&gt;
    --&gt; Pt: 258.0812683105469, Eta: -1.9664770364761353, Phi: 0.5708979964256287, Charge: -1, Matched_segments_stations: [...], Showered: True
    * GenMuon 1 info --&gt;
    --&gt; Pt: 190.72511291503906, Eta: -0.2504693865776062, Phi: -2.558511257171631, Charge: 1, Matched_segments_stations: [...], Showered: True
+ Emushowers
    * Number of emushowers: 0
+ Simhits
    * Number of simhits: 50
+ Realshowers
    * Number of realshowers: 0
Event orbit number: -1
</pre></div>
</div>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>The <code class="docutils literal notranslate"><span class="pre">NTuple.events</span></code> attribute is not a simple list, but an instance of the <a class="reference internal" href="#event-list"><span class="std std-ref">EventList</span></a> class.
This design prevents loading all events into memory simultaneously. Instead, it allows iteration and access by index and slice,
while internally iterating over the root tree entries to create the required event on the fly.</p>
</div>
</section>
<section id="eventlist">
<span id="event-list"></span><h2>EventList<a class="headerlink" href="#eventlist" title="Link to this heading"></a></h2>
<p>Since a ROOT TTree can contain many events (entries), it is useful to have a class that manages a
list of <code class="docutils literal notranslate"><span class="pre">Event</span></code> instances. The <code class="docutils literal notranslate"><span class="pre">EventList</span></code> class allows users to access specific events by index
or slice, and is designed to handle <code class="docutils literal notranslate"><span class="pre">Event</span></code> instances created directly from a ROOT TTree.</p>
<p>An <code class="docutils literal notranslate"><span class="pre">EventList</span></code> instance cannot be created by directly passing <code class="docutils literal notranslate"><span class="pre">Event</span></code> instances. This restriction
exists to minimize memory usage. Instead of storing all events in memory, the class generates event
instances on demand when the user requests a specific event or a subset of events using the TTree.</p>
<p>To create an <code class="docutils literal notranslate"><span class="pre">EventList</span></code> instance, only the ROOT tree and an optional event preprocessing function
are required. The preprocessing function is applied to each generated <code class="docutils literal notranslate"><span class="pre">Event</span></code> instance.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>This class is not intended to be instantiated directly by the user. It is used internally by the
<code class="docutils literal notranslate"><span class="pre">NTuple</span></code> class to manage events.</p>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="event_abstraction.html" class="btn btn-neutral float-left" title="Event Abstraction" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="configuration_management.html" class="btn btn-neutral float-right" title="Configuration Management" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Daniel Estrada, Universidad de Oviedo.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>